@page
@model Front.Pages.Usuarios.IndexModel
@{
    Layout = "_Layout";
}

<h1>Usuarios</h1>

<a class="btn btn-primary" asp-area="" asp-page="/Usuarios/Crear">Nuevo registro</a>

<div class="table-responsive mt-4">
    <table class="table table-primary">
        <thead>
            <tr>
                <th>Id</th>
                <th>Nombre</th>
                <th>Correo</th>
                <th>País</th>
                <th>Provincia</th>
                <th>Cantón</th>
                <th>Distrito</th>
                <th>Dirección exacta</th>
                <th>Rol</th>
                <th>Teléfono</th>
                <th>Fecha de registro</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="listaDatos"></tbody>
    </table>
</div>

<script>
    const API_URL = 'https://localhost:7096/Usuario';
    const DIR_URL = 'https://localhost:7096/Direccion';

    function cargarDatos() {
        $.get(API_URL, function (usuarios) {
            $("#listaDatos").empty();

            usuarios.forEach(u => {
                $.get(`${DIR_URL}/${u.id_direccion}`, function (dir) {
                    const distritoId = dir.id_distrito;
                    const cantonId = dir.id_canton;
                    const provinciaId = dir.id_provincia;
                    const paisId = dir.id_pais;

                    $.when(
                        $.get(`https://localhost:7096/Distrito/${distritoId}`),
                        $.get(`https://localhost:7096/Canton/${cantonId}`),
                        $.get(`https://localhost:7096/Provincia/${provinciaId}`),
                        $.get(`https://localhost:7096/Pais/${paisId}`),
                        $.get(`https://localhost:7096/Roles/${u.id_rol}`),
                        $.get(`https://localhost:7096/Estados/${u.id_estado}`)
                    ).done(function (distResp, cantonResp, provResp, paisResp, rolResp, estadoResp) {
                        const dist = distResp[0];
                        const canton = cantonResp[0];
                        const prov = provResp[0];
                        const pais = paisResp[0];
                        const rol = rolResp[0];
                        const estado = estadoResp[0];

                        $("#listaDatos").append(`
                            <tr>
                                <td>${u.id}</td>
                                <td>${u.nombre}</td>
                                <td>${u.correo}</td>
                                <td>${pais.nombre}</td>
                                <td>${prov.nombre}</td>
                                <td>${canton.nombre}</td>
                                <td>${dist.nombre}</td>
                                <td>${dir.detalle}</td>
                                <td>${rol.nombre}</td>
                                <td>${u.telefono}</td>
                                <td>${u.fecha_registro.split('T')[0]}</td>
                                <td>${estado.nombre}</td>
                                <td>
                                    <a class="btn btn-primary" href="/Usuarios/Editar?id=${u.id}">Editar</a>
                                    <a class="btn btn-danger" onclick="eliminarUsuario('${u.id}')">Eliminar</a>
                                </td>
                            </tr>
                        `);
                    });
                });
            });
        });
    }



    function eliminarUsuario(id) {
        if (!confirm("¿Desea eliminar este usuario?")) return;

        $.ajax({
            url: `${API_URL}?id=${id}`,
            type: 'DELETE',
            success: function () {
                alert("Usuario eliminado");
                cargarDatos();
            },
            error: function (e) {
                console.error("Error al eliminar:", e);
            }
        });
    }

    $(document).ready(function () {
        cargarDatos();
    });
</script>

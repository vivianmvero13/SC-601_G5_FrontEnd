@page
@model Front.Pages.Promociones.EditarModel
@{
    Layout = "_Layout";
}

<div class="container">

    <input type="hidden" id="id" />

    <div class="mb-3">
        <label class="form-label">Descripción</label>
        <input type="text" class="form-control" id="descripcion" />
    </div>

    <div class="mb-3">
        <label class="form-label">Descuento (%)</label>
        <input type="number" class="form-control" id="descuento" />
    </div>

    <div class="mb-3">
        <label class="form-label">Fecha de Inicio</label>
        <input type="date" class="form-control" id="fecha_inicio" />
    </div>

    <div class="mb-3">
        <label class="form-label">Fecha de Fin</label>
        <input type="date" class="form-control" id="fecha_fin" />
    </div>

    <div class="mb-3">
        <label class="form-label">Producto</label>
        <select class="form-control" id="id_producto"></select>
    </div>

    <button id="modificarDatos" class="btn btn-success">Actualizar</button>
    <a class="btn btn-warning" asp-area="" asp-page="/Promociones/IndexAdmin">Cancelar</a>

</div>

<script>
    const API_URL = 'https://localhost:7096/Promociones';
    const PRODUCTO_URL = 'https://localhost:7096/Productos';
    const id = new URLSearchParams(window.location.search).get("id");

    cargarProductos().then(() => {
        $.get(`${API_URL}/${id}`, function (p) {
            $('#id').val(p.id);
            $('#descripcion').val(p.descripcion);
            $('#descuento').val(p.descuento);
            $('#fecha_inicio').val((p.fecha_inicio || '').split('T')[0] || p.fecha_inicio);
            $('#fecha_fin').val((p.fecha_fin || '').split('T')[0] || p.fecha_fin);
            $('#id_producto').val(p.id_producto);
        }).fail(function () {
            alert("No se pudo cargar la promoción.");
        });
    });

    $('#modificarDatos').click(function () {
        const promocion = {
            id: parseInt($('#id').val(), 10),
            descripcion: $('#descripcion').val().trim(),
            descuento: Number($('#descuento').val()),
            fecha_inicio: $('#fecha_inicio').val(),
            fecha_fin: $('#fecha_fin').val(),
            id_producto: parseInt($('#id_producto').val(), 10)
        };

        $.ajax({
            url: `${API_URL}`,
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(promocion),
            success: function () {
                alert("Promoción actualizada correctamente");
                window.location.href = '/Promociones/IndexAdmin';
            },
            error: function () {
                alert("No se pudo actualizar la promoción.");
            }
        });
    });

    function cargarProductos() {
        return $.get(PRODUCTO_URL, function (data) {
            const $sel = $('#id_producto');
            $sel.empty().append('<option value="">Seleccione</option>');
            const lista = Array.isArray(data) ? data : [data];
            lista.forEach(p => $sel.append(`<option value="${p.id}">${p.nombre}</option>`));
        }).fail(function () {
            alert("No se pudo cargar la lista de productos.");
        });
    }
</script>
